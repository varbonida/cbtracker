let subs=[],txs=[],fightInterval=10;const fightAddress=$("#fight-address"),fightResult=$("#fight-result");async function subscribe(e){console.log("Subscribed:",e),subs[e]=setInterval(async()=>{try{const t=await getLatestBlock(),n=await getPastEvents("FightOutcome",t.number-5,t.number,"0x39bea96e13453ed52a734b6aceed4c41f57b2271",["0x7a58aac6530017822bf3210fccef7efa31f56277f19966bc887bfb11f40ca96d",web3.eth.abi.encodeParameter("address",e)]);n.length>0&&n.forEach(async e=>{if(!txs.includes(e.transactionHash)){const{character:t,enemyRoll:n,playerRoll:i,owner:a,skillGain:s,xpGain:o,weapon:l}=e.returnValues,r=await getTransaction(e.transactionHash),d=await getTransactionReceipt(e.transactionHash),c=r.gasPrice*d.gasUsed;fightResult.append(`${a},${parseInt(i)>parseInt(n)?"Win":"Lost"},${t},${l},${i},${n},${web3.utils.fromWei(BigInt(s).toString(),"ether")},${o},${web3.utils.fromWei(BigInt(c).toString(),"ether")}\n`),txs.push(e.transactionHash)}})}catch(e){console.log(e)}},1e3)}async function addAccount(){var e=$("#logger-address").val().trim();!Object.keys(subs).includes(e)&&isAddress(e)&&(await subscribe(e),fightAddress.append(`${e}\n`),$("#modal-add-account").modal("hide"))}function exportList(){var e=fightAddress.val().split("\n");if(e.splice(e.length-1,1),e.length>0){var t=e.join("\n"),n=new Blob([t],{type:"text/plain"}),i=window.URL.createObjectURL(n),a=document.createElement("a");a.download=`CBTracker-Address-List-${(new Date).getTime()}.txt`,a.innerHTML="Download File",a.href=i,a.onclick=function(){document.body.removeChild(event.target)},a.style.display="none",document.body.appendChild(a),a.click()}}function exportLogs(){var e=fightResult.val().split("\n");if(e.splice(e.length-1,1),e.length>0){var t=e.join("\n"),n=new Blob([t],{type:"text/plain"}),i=window.URL.createObjectURL(n),a=document.createElement("a");a.download=`CBTracker-Fight-Logs-${(new Date).getTime()}.txt`,a.innerHTML="Download File",a.href=i,a.onclick=function(){document.body.removeChild(event.target)},a.style.display="none",document.body.appendChild(a),a.click()}}function importList(){if(!(window.File&&window.FileReader&&window.FileList&&window.Blob))return alert("The File APIs are not fully supported in this browser.");var e=document.getElementById("file-import");if(!e)return alert("Um, couldn't find the fileinput element.");if(!e.files)return alert("This browser doesn't seem to support the `files` property of file inputs.");if(!e.files[0])return alert("Please select a file before clicking 'Import'");if("text/plain"===e.files[0].type){var t=e.files[0],n=new FileReader;n.readAsText(t),n.addEventListener("load",function(){var e=n.result.split("\r\n");console.log(e),e.length&&e.forEach(async e=>{!Object.keys(subs).includes(e)&&isAddress(e)&&(await subscribe(e),fightAddress.append(`${e}\n`))}),$("#modal-import").modal("hide")})}else alert("Please import a valid json/text file")}function copy_address_to_clipboard(){navigator.clipboard.writeText("0x2548696795a3bCd6A8fAe7602fc26DD95A612574").then(e=>alert("Copied Address"),e=>alert("Fail\n"+e))}window.addEventListener("beforeunload",function(e){fightResult.val()&&(e.preventDefault(),e.returnValue="Your fight logs will be lost. Please save them before closing/refreshing this page")}),$("#modal-add-account").on("shown.bs.modal",function(e){$("#logger-address").val("")}),window.addEventListener("beforeunload",function(e){fightResult.val()&&(e.preventDefault(),e.returnValue="Your fight logs will be lost. Please save them before closing/refreshing this page")});